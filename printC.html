<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Prompt', sans-serif;
  background: white;
  color: #2d3748;
  min-height: 100vh;
  padding: 0;
  margin: 0;
}

.print-container {
  max-width: 100%;
  width: 100%;
  margin: 0;
  background: white;
  padding: 1rem;
}

.print-header {
  display: none;
}

@media screen {
  .print-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, #c00 0%, #f44336 100%);
    color: white;
    border-radius: 12px;
  }
  
  .print-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
  }
  
  body {
    background: linear-gradient(135deg, #c00 0%, #f44336 100%);
    padding: 1rem;
  }
  
  .print-container {
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  }
}

.print-actions {
  display: flex;
  gap: 1rem;
}

.btn {
  background: linear-gradient(135deg, #c00 0%, #f44336 100%);
  border: none;
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Prompt', sans-serif;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(192, 0, 0, 0.4);
}

.btn-secondary {
  background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
}

#calendar {
  background: white;
  padding: 0.5rem;
  min-height: 600px;
}

.fc {
  width: 100% !important;
}

.fc-view-harness {
  height: auto !important;
  min-height: 600px !important;
}

.fc-daygrid-body {
  width: 100% !important;
}

.fc-daygrid-day-frame {
  min-height: 120px !important;
}

.fc .fc-toolbar-title {
  background: linear-gradient(135deg, #c00 0%, #f44336 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 700;
  font-size: 1.5rem;
}

.fc .fc-button-primary {
  background: linear-gradient(135deg, #c00 0%, #f44336 100%);
  border: none;
  color: #fff;
  border-radius: 10px;
  padding: 0.5rem 1rem;
  font-weight: 500;
}

.fc .fc-daygrid-event {
  border-radius: 6px;
  padding: 4px 6px;
  margin: 2px 0;
  border-left: 4px solid;
  font-size: 0.75rem;
  white-space: normal;
  line-height: 1.3;
  display: block;
  width: 100%;
}

.fc-daygrid-day-events {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.fc-daygrid-event-harness {
  margin: 2px 0 !important;
}

.legend {
  display: none;
}

@media screen {
  .legend {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
    padding: 1rem;
    background: #f7fafc;
    border-radius: 12px;
    flex-wrap: wrap;
  }
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.legend-color {
  width: 30px;
  height: 20px;
  border-radius: 4px;
}

/* ====== Print Styles ====== */
@media print {
  @page {
    size: A4 portrait;
    margin: 10mm;
  }
  
  body {
    background: white !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  
  .print-header, .print-actions, .btn, .legend {
    display: none !important;
  }
  
  .print-container {
    box-shadow: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  
  #calendar {
    width: 100% !important;
    max-width: none !important;
    margin: 0 !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
    page-break-inside: avoid;
  }
  
  .fc {
    font-size: 11px !important;
  }
  
  .fc-toolbar-title {
    font-size: 18px !important;
    color: #c00 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  
  .fc .fc-button-primary {
    display: none !important;
  }
  
  .fc-daygrid-day-number {
    font-size: 12px !important;
  }
  
  .fc-daygrid-event {
    font-size: 9px !important;
    padding: 2px 4px !important;
    margin: 1px 0 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    display: block !important;
    width: 100% !important;
  }
  
  .fc-daygrid-event-harness {
    margin: 2px 0 !important;
  }
  
  .fc-col-header-cell {
    font-size: 11px !important;
    font-weight: bold !important;
  }
  
  .fc-daygrid-day-frame {
    min-height: 120px !important;
  }
  
  .fc-daygrid-day-events {
    display: flex !important;
    flex-direction: column !important;
    gap: 2px !important;
  }
}

@media (max-width: 768px) {
  .print-header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .print-actions {
    width: 100%;
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
  }
  
  .legend {
    flex-direction: column;
    gap: 1rem;
  }
}

.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 400px;
  font-size: 1.25rem;
  color: #c00;
}

.loading-spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(192, 0, 0, 0.3);
  border-radius: 50%;
  border-top-color: #c00;
  animation: spin 1s ease-in-out infinite;
  margin-right: 1rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="print-container">
  <div class="print-header">
    <div>
      <div class="print-title">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</div>
      <div style="font-size: 0.875rem; color: #718096; margin-top: 0.5rem;">
        ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="printDate"></span>
      </div>
    </div>
    <div class="print-actions">
      <button class="btn" onclick="window.print()">
        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
      </button>
      <button class="btn btn-secondary" onclick="window.history.back()">
        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
      </button>
    </div>
  </div>

  <div id="calendar" class="loading">
    <div class="loading-spinner"></div>
    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
  </div>

  <div class="legend">
    <div style="font-weight: 600; width: 100%; margin-bottom: 0.5rem;">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</div>
    <div class="legend-item">
      <div class="legend-color" style="background: gray;"></div>
      <span>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #E3C565;"></div>
      <span>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: green;"></div>
      <span>‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: darkred;"></div>
      <span>‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #2196F3;"></div>
      <span>‡∏ß‡∏±‡∏ô‡∏•‡∏≤</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #FF9800;"></div>
      <span>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, collection, getDocs
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXayBBLVSohNCIsnlWRq6rD0BUbW70MGk",
  authDomain: "events-666d6.firebaseapp.com",
  projectId: "events-666d6",
  storageBucket: "events-666d6.firebasestorage.app",
  messagingSenderId: "589078390914",
  appId: "1:589078390914:web:480ce96137ffac835aac9b",
  measurementId: "G-97GD75S814"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function addOneDayForCalendar(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr + "T00:00:00");
  d.setDate(d.getDate() + 2);
  return d.toISOString().split("T")[0];
}

function formatDateTimeThai() {
  const now = new Date();
  const day = String(now.getDate()).padStart(2, '0');
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const year = now.getFullYear() + 543;
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  return `${day}/${month}/${year} ‡πÄ‡∏ß‡∏•‡∏≤ ${hours}:${minutes} ‡∏ô.`;
}

document.addEventListener("DOMContentLoaded", async () => {
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå
  document.getElementById("printDate").textContent = formatDateTimeThai();

  const calendarEl = document.getElementById("calendar");
  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale: "th",
    timeZone: "Asia/Bangkok",
    initialView: "dayGridMonth",
    firstDay: 0,
    dayHeaders: true,
    weekends: true,
    headerToolbar: { 
      left: "prev,next", 
      center: "title", 
      right: "today" 
    },
    contentHeight: 'auto',
    aspectRatio: 0.7,
    eventDisplay: 'block',
    displayEventTime: false,
    eventContent: function(arg) {
      const data = arg.event.extendedProps;
      const el = document.createElement("div");

      if (data.type === "leave") {
        el.innerHTML = `<div style="background:#E3F2FD;border-left:4px solid #2196F3;padding:4px;border-radius:4px;font-size:0.7rem;">
          <strong style="display:block;margin-bottom:2px;">üèñ ${arg.event.title}</strong>
          <span style="font-size:0.65rem;">${data.reason||'-'}</span>
        </div>`;
      } else if (data.type === "holiday") {
        el.innerHTML = `<div style="background:#FF9800;border-radius:4px;padding:4px;color:#fff;text-align:center;font-size:0.7rem;">
          üéâ ${arg.event.title}
        </div>`;
      } else {
        let acknowledgeLabel = "";
        if (data.status !== "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" && data.status !== "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") {
          let workersList = [];
          if (arg.event.title && typeof arg.event.title === 'string') {
            workersList = arg.event.title.split(",").map(name => name.trim()).filter(name => name.length > 0);
          }
          const totalWorkers = workersList.length;
          
          let acknowledgedList = [];
          if (data.acknowledgedBy) {
            if (Array.isArray(data.acknowledgedBy)) {
              acknowledgedList = data.acknowledgedBy.map(name => name.trim().normalize('NFC'));
            } else if (typeof data.acknowledgedBy === 'string' && data.acknowledgedBy.trim() !== '') {
              acknowledgedList = data.acknowledgedBy.split(",").map(name => name.trim().normalize('NFC'));
            }
          }
          
          let circles = "";
          for (let i = 0; i < totalWorkers; i++) {
            if (i < acknowledgedList.length) {
              circles += `<span style="display:inline-block;width:14px;height:14px;background:#4CAF50;border-radius:50%;margin:0 1px;text-align:center;line-height:14px;color:#fff;font-size:9px;">‚úì</span>`;
            } else {
              circles += `<span style="display:inline-block;width:14px;height:14px;background:rgba(255,255,255,0.3);border:2px solid #fff;border-radius:50%;margin:0 1px;"></span>`;
            }
          }
          
          acknowledgeLabel = circles;
        }
        
        const locationDisplay = data.location || "-";
        const howtoDisplay = data.howto ? ` (${data.howto})` : "";
        
        el.innerHTML = `<div style="font-size:0.7rem;line-height:1.3;">
            <strong style="display:block;margin-bottom:2px;">${arg.event.title}</strong>
            <div style="font-size:0.65rem;">üìç ${locationDisplay}${howtoDisplay}</div>
            <div style="font-size:0.65rem;">üß∞ ${data.jobTypes || "-"}</div>
            <div style="font-size:0.65rem;">üìå ${data.status || "-"} ${acknowledgeLabel}</div>
        </div>`;
      }

      return { domNodes: [el] };
    },
    height: 'auto'
  });

  try {
    const allEvents = [];

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô
    const eventSnap = await getDocs(collection(db, "events"));
    eventSnap.forEach(docItem => {
      const data = docItem.data();
      let color = "#A9A9A9";
      if (data.status === "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") color = "gray";
      else if (data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") color = "#E3C565";
      else if (data.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") color = "green";
      else if (data.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") color = "darkred";

      allEvents.push({
        id: docItem.id,
        title: Array.isArray(data.workers) ? data.workers.join(", ") : (data.workers || "-"),
        start: data.start || "",
        end: data.end ? addOneDayForCalendar(data.end) : undefined,
        location: data.location || "",
        howto: data.howto || "",
        jobNumber: data.jobNumber || "-",
        jobTypes: Array.isArray(data.jobTypes) ? data.jobTypes.join(", ") : (data.jobTypes || "-"),
        status: data.status || "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
        acknowledged: data.acknowledged || false,
        acknowledgedBy: data.acknowledgedBy || "",
        backgroundColor: color,
        borderColor: color,
        textColor: "#fff",
        type: "event",
        allDay: true
      });
    });

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏•‡∏≤
    const leaveSnap = await getDocs(collection(db, "leaves"));
    leaveSnap.forEach(docItem => {
      const data = docItem.data();
      allEvents.push({
        id: "leave-" + docItem.id,
        title: data.name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠",
        start: data.start || "",
        end: data.end ? addOneDayForCalendar(data.end) : undefined,
        backgroundColor: "#2196F3",
        borderColor: "#2196F3",
        textColor: "#000000",
        type: "leave",
        reason: data.reason || "",
        allDay: true
      });
    });

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
    const holidaySnap = await getDocs(collection(db, "holidays"));
    holidaySnap.forEach(docItem => {
      const data = docItem.data();
      allEvents.push({
        id: "holiday-" + docItem.id,
        title: data.name || "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î",
        start: data.date || "",
        end: data.date ? addOneDayForCalendar(data.date) : undefined,
        backgroundColor: "#FF9800",
        borderColor: "#FF9800",
        textColor: "#fff",
        type: "holiday",
        allDay: true
      });
    });

    calendar.addEventSource(allEvents);
    calendar.render();
  } catch (err) {
    console.error("Error loading calendar:", err);
    document.getElementById("calendar").innerHTML = `
      <div style="color: #c00; text-align: center; padding: 2rem;">
        <strong>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</strong><br>
        <small>${err.message}</small>
      </div>`;
  }
});
</script>

</body>
</html>