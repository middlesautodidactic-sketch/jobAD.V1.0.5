<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</title>

<!-- PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Firebase -->
<script type="module" src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js"></script>

<style>
body { font-family: "TH Sarabun New", sans-serif; background: #f8fafc; margin:0; font-size:14px; }
.header-bar { display:flex; justify-content:space-between; align-items:center; background:linear-gradient(90deg,#c82a11,#ff0101); color:#fff; padding:12px 10px; }
.header-bar h1 { margin:0; font-size:16px; font-weight:600; }
.header-bar button { background:rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.3); border-radius:8px; padding:6px 12px; cursor:pointer; }
.header-bar button:hover { background:rgba(255,255,255,0.25); }

.btn-group { display:flex; justify-content:center; gap:10px; margin:10px 0; align-items:center; }
.btn { background:#ff0101; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.2s; }
.btn:hover { background:#c82a11; }
.btn:disabled { background:#94a3b8; cursor:not-allowed; }
.btn.secondary { background:#64748b; }
.btn.secondary:hover { background:#475569; }

.container { 
  width:210mm; 
  min-height:297mm;
  max-height:297mm;
  background:#fff; 
  margin:10px auto; 
  padding:15mm 18mm; 
  box-shadow:0 6px 20px rgba(0,0,0,0.08); 
  border-radius:12px; 
  box-sizing:border-box; 
  transition:opacity 0.3s;
  overflow:hidden;
  page-break-inside: avoid;
  page-break-after: avoid;
}

.header-title { text-align:center; margin-bottom:3mm; }
.header-title h2 { margin:0 0 1.5mm 0; text-decoration:underline; font-weight:700; font-size:17px; }
.header-title .jobno { text-align:right; font-size:13px; margin-top:0; }

.line { border-bottom:1px dotted #000; display:inline-block; min-width:35mm; padding:1px 0; text-align:center; line-height:1.6; }
.lines { border-bottom:1px dotted #000; display:inline-block; min-width:35mm; padding:1px 0; text-align:center; line-height:1.6; }
.line1 { border-bottom:1px dotted #000; display:inline-block; min-width:36.7mm; padding:1px 0; text-align:center; line-height:1.6; }
.line2 { border-bottom:1px dotted #000; display:inline-block; min-width:58.4mm; padding:1px 0; text-align:center; line-height:1.6; }
.line3 { border-bottom:1px dotted #000; display:inline-block; min-width: 145mm; padding:1px 0; text-align:center; line-height:1.6; }
.line4 { border-bottom:1px dotted #000; display:inline-block; min-width:60mm; padding:1px 0; text-align:center; line-height:1.6; }
.line5 { border-bottom:1px dotted #000; display:inline-block; min-width:127.5mm; padding:1px 0; text-align:center; line-height:1.6; }
.line7 { border-bottom:1px dotted #000; display:inline-block; min-width:154mm; padding:1px 0; text-align:center; line-height:1.6; }
.line9 { border-bottom:1px dotted #000; display:inline-block; min-width:156.5mm; padding:1px 0; text-align:center; line-height:1.6; }
.line8 { border-bottom:1px dotted #000; display:inline-block; min-width:75.5mm; padding:1px 0; text-align:center; line-height:1.6; }
.line6 { border-bottom:1px dotted #000; display:inline-block; min-width:180mm; padding:1px 0; text-align:center; min-height:8mm; vertical-align:top; line-height:1.6; }

.section { 
  margin-top:2.5mm; 
  line-height:1.4; 
  page-break-inside: avoid;
}

textarea { width:100%; border:none; border-bottom:1px dotted #000; resize:none; font-size:13px; background:transparent; padding:2px 0; }
input[type="checkbox"] { transform:scale(1.0); margin-right:2px; }

.signature { 
  margin-top:12mm; 
  display:flex; 
  justify-content:space-between;
  page-break-inside: avoid;
  align-items: flex-start;
}
.signature div { text-align:center; width:45%; font-size:13px; line-height:1.5; }
.signature img { max-height:40px; }

input[type="text"] { padding:8px 12px; font-size:14px; border:1px solid #ddd; border-radius:6px; width:200px; }
.search-box { display:flex; gap:10px; align-items:center; }

.details-box {
  border-bottom:1px dotted #000; 
  min-height:6mm; 
  padding:1px 0; 
  line-height:1.5;
  page-break-inside: avoid;
}

/* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏¥‡πâ‡∏ô */
@media print {
  @page {
    size: A4 portrait;
    margin: 0;
  }
  
  body {
    margin: 0;
    padding: 0;
  }
  
  .container {
    width: 210mm !important;
    min-height: 297mm !important;
    max-height: 297mm !important;
    padding: 15mm 18mm !important;
    margin: 0 !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    page-break-inside: avoid !important;
    page-break-after: avoid !important;
    overflow: hidden !important;
  }
  
  .line, .lines, .line1, .line2, .line3, .line4, .line5, .line6, .line7, .line8, .line9 {
    border-bottom: 1px dotted #000 !important;
    padding: 1px 0 !important;
    line-height: 1.6 !important;
    display: inline-block !important;
    box-sizing: border-box !important;
    page-break-inside: avoid !important;
  }
  
  .section {
    page-break-inside: avoid !important;
    margin-top: 2.5mm !important;
  }
  
  .signature {
    page-break-inside: avoid !important;
    margin-top: 12mm !important;
  }
  
  .details-box {
    page-break-inside: avoid !important;
  }
  
  .header-bar, .btn-group {
    display: none !important;
  }
}
</style>
</head>

<body>

<div class="header-bar">
  <h1>üìÑ ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h1>
  <button onclick="window.location.href='notchoose.html'">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</div>

<div class="btn-group">
  <div class="search-box">
    <label>Job Number:</label>
    <input type="text" id="jobNumberInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Job Number...">
    <button class="btn secondary" id="searchBtn">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  </div>
  <button class="btn" id="printBtn">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô PDF</button>
</div>

<div id="report" class="container">

  <!-- üîπ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô -->
  <div class="header-title">
    <h2>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h2>
    <div class="jobno">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="jobNo" class="line"></span></div>
  </div>

  <div class="section" style="margin-top:2mm;">
    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: <span id="assignedBy" class="line"></span>
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: <span id="orderDate" class="line"></span>
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô: <span id="deadlines" class="line1"></span><br>
  </div>

  <div class="section">
    ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏á‡∏≤‡∏ô:
    <div style="text-align: right;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà JOB: <span id="docNo" class="line"></span></div>
    <label><input type="checkbox" id="type1"> ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</label>
    <label><input type="checkbox" id="type2"> ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°</label>
    <label><input type="checkbox" id="type3"> ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Å/‡∏ã‡πà‡∏≠‡∏°</label>
    <label><input type="checkbox" id="type4"> Visit</label>
    <label><input type="checkbox" id="type5"> ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</label>
  </div>

  <div class="section">
    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:<br>
    <div class="details-box">
      <span id="details"></span>
    </div>
    <div class="details-box">
      <span id="details2"></span>
    </div>
  </div>

  <div class="section">
    ‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="date" class="line2"></span>
    ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="deadline" class="line2"></span>
  </div>

  <div class="section">
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: <span id="location" class="line3"></span>
  </div>

  <div class="section">
    ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <span id="contactName" class="line4"></span>
    ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: <span id="contactPhone" class="line8"></span>
  </div>

  <div class="section">
    ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: <span id="title" class="line7"></span>
  </div>

  <div style="border-top:1px solid #ccc; margin:8mm 0 4mm 0;"></div>

  <div class="section">
    ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:<br>
    <label><input type="checkbox" id="success"> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</label>
    <label><input type="checkbox" id="fail"> ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</label>
    <span id="incompleteReason" class="line5"></span><br>
    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span id="note" class="line9"></span>
  </div>

  <div class="signature">
    <div>
      <br><br><br>(..........................................)<br><br>
      ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
    </div>
    <div style="position:relative;">
      <img id="signatureImg" 
           src="https://i.postimg.cc/Ny0GLn2m/signature.png" 
           style="display:none; max-height:35px; position:absolute; bottom: 50px; left:50%; transform:translateX(-50%);"
           crossorigin="anonymous">
      <br><br><br>(..........................................)<br><br>
      ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
    </div>
  </div>
  
  <div class="signature" style="margin-top:8mm; font-size:12px;">
    <div style="text-align:left;">
      <u>‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!</u> ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£<br>
      1. ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      2. ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏° ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      3. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      4. ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏° ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      5. Visit ‡∏á‡∏≤‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£
    </div>
    <div>
      ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡πà‡∏ß‡∏ô!<br><br><br>
      (..........................................)<br>
      ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏Ñ‡∏∏‡∏ì‡∏â‡∏±‡∏ï‡∏£‡∏ä‡∏±‡∏¢
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXayBBLVSohNCIsnlWRq6rD0BUbW70MGk",
  authDomain: "events-666d6.firebaseapp.com",
  projectId: "events-666d6",
  storageBucket: "events-666d6.appspot.com",
  messagingSenderId: "589078390914",
  appId: "1:589078390914:web:480ce96137ffac835aac9b",
  measurementId: "G-97GD75S814"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const jobNumberInput = document.getElementById("jobNumberInput");
const searchBtn = document.getElementById("searchBtn");
const signatureImg = document.getElementById("signatureImg");

let isDataLoaded = false;

function getParamsFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    jobNumber: urlParams.get('job'),
    start: urlParams.get('start'),
    end: urlParams.get('end')
  };
}

async function searchAndDisplay(jobNum = null) {
  const jobNumber = jobNum || jobNumberInput.value.trim();
  
  if (!jobNumber) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Job Number");
    return;
  }

  document.getElementById("report").style.opacity = "0.5";
  isDataLoaded = false;

  try {
    const q = query(collection(db, "events"), where("jobNumber", "==", jobNumber));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Job Number: " + jobNumber);
      document.getElementById("report").style.opacity = "1";
      return;
    }

    const data = querySnapshot.docs[0].data();
    
    if (data.signType === "‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏á") {
      const currentParams = new URLSearchParams(window.location.search);
      window.location.href = `reportAp.html?${currentParams.toString()}`;
      return;
    }

    signatureImg.style.display = (data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" || data.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || data.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") ? "block" : "none";
    
    function formatDateThai(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear() + 543;
      return `${day}/${month}/${year}`;
    }

    const formattedStart = formatDateThai(data.start);
    const formattedOrderDate = formatDateThai(data.orderDate);
    const formattedEnd = formatDateThai(data.end);

    document.getElementById("docNo").textContent = data.jobNumber || "";
    document.getElementById("jobNo").textContent = data.job || "";
    document.getElementById("assignedBy").textContent = (data.assigners || []).join(", ");
    document.getElementById("date").textContent = formattedStart;
    document.getElementById("orderDate").textContent = formattedOrderDate;
    document.getElementById("deadline").textContent = formattedEnd;
    document.getElementById("deadlines").textContent = formattedEnd;

    const detailsText = data.details || "";
    const maxLength = 100;
    if (detailsText.length > maxLength) {
      document.getElementById("details").textContent = detailsText.substring(0, maxLength);
      document.getElementById("details2").textContent = detailsText.substring(maxLength);
    } else {
      document.getElementById("details").textContent = detailsText;
      document.getElementById("details2").textContent = "";
    }
    
    document.getElementById("location").textContent = data.location || "";
    document.getElementById("title").textContent = (data.workers || []).join(", ");
    document.getElementById("contactName").textContent = data.contactPerson || "-";
    document.getElementById("contactPhone").textContent = data.phoneNumber || "-";

    ["type1","type2","type3","type4","type5"].forEach(id => document.getElementById(id).checked=false);

    if (data.jobTypes) {
      if (data.jobTypes.includes("‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö")) document.getElementById("type1").checked = true;
      if (data.jobTypes.includes("‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°")) document.getElementById("type2").checked = true;
      if (data.jobTypes.includes("‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°")) document.getElementById("type3").checked = true;
      if (data.jobTypes.includes("Visit")) document.getElementById("type4").checked = true;

      const other = data.jobTypes.find(t =>
        !["‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö","‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°","‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°","Visit"].includes(t)
      );
      if (other) document.getElementById("type5").checked = true;
    }

    document.getElementById("success").checked = data.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    document.getElementById("fail").checked = data.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    document.getElementById("note").textContent = data.remark || "";
    document.getElementById("incompleteReason").textContent = data.incompleteReason || "";

    isDataLoaded = true;
    document.getElementById("report").style.opacity = "1";
    alert("‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Job Number: " + jobNumber);

  } catch (error) {
    console.error("Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
    document.getElementById("report").style.opacity = "1";
    isDataLoaded = false;
  }
}

searchBtn.addEventListener("click", () => searchAndDisplay());
jobNumberInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") searchAndDisplay();
});

window.addEventListener('DOMContentLoaded', async () => {
  console.log("üåê ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö...");
  await new Promise(resolve => setTimeout(resolve, 1500));
  console.log("‚úÖ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
  
  const params = getParamsFromURL();
  
  if (params.jobNumber) {
    jobNumberInput.value = params.jobNumber;
    if (params.start) console.log("‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°:", params.start);
    if (params.end) console.log("‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:", params.end);
    searchAndDisplay(params.jobNumber);
  }
});

document.getElementById("printBtn").addEventListener("click", async () => {
  console.log("üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô...");
  
  if (!isDataLoaded) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô!");
    return;
  }

  const jobNumber = document.getElementById("docNo").textContent.trim();
  if (!jobNumber) {
    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà!");
    isDataLoaded = false;
    return;
  }

  const printBtn = document.getElementById("printBtn");
  const originalText = printBtn.textContent;
  printBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...";
  printBtn.disabled = true;

  try {
    console.log("üìÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...");
    const element = document.getElementById("report");
    const filename = `${jobNumber}.pdf`;

    // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)
    const signatureImg = document.getElementById("signatureImg");
    if (signatureImg && signatureImg.style.display !== "none") {
      console.log("‚è≥ ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô...");
      
      const preloadImg = new Image();
      preloadImg.crossOrigin = "anonymous";
      preloadImg.src = signatureImg.src;
      
      await new Promise((resolve) => {
        if (signatureImg.complete && signatureImg.naturalWidth > 0) {
          console.log("‚úÖ ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
          resolve();
          return;
        }
        
        preloadImg.onload = () => {
          console.log("‚úÖ Preload ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          signatureImg.src = preloadImg.src;
          setTimeout(resolve, 500);
        };
        
        preloadImg.onerror = () => {
          console.log("‚ö†Ô∏è Preload ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡∏Ç‡πâ‡∏≤‡∏°");
          resolve();
        };
        
        setTimeout(() => {
          console.log("‚è±Ô∏è Timeout ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (8s)");
          resolve();
        }, 8000);
      });
    }

    console.log("‚è≥ ‡∏£‡∏≠ DOM ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå...");
    await new Promise(resolve => setTimeout(resolve, 3000));

    console.log("üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á render HTML to Canvas...");

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß - ‡∏õ‡∏£‡∏±‡∏ö scale ‡πÅ‡∏•‡∏∞ pagebreak
    await html2pdf().set({
      margin: 0,
      filename: filename,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { 
        scale: 2.5,
        useCORS: true,
        allowTaint: true,
        logging: false,
        letterRendering: true,
        windowHeight: 297 * 3.7795275591,
        height: 297 * 3.7795275591,
        backgroundColor: '#ffffff',
        removeContainer: true,
        imageTimeout: 15000
      },
      jsPDF: { 
        unit: "mm", 
        format: "a4", 
        orientation: "portrait",
        compress: true
      },
      pagebreak: { mode: 'avoid-all' }
    }).from(element).save();

    console.log("‚úÖ PDF ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    alert("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + filename);

  } catch (error) {
    console.error("‚ùå PDF Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
  } finally {
    printBtn.textContent = originalText;
    printBtn.disabled = false;
  }
});
</script>
</body>
</html>